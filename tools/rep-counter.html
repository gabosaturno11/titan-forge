<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rep Counter | Saturno Movement</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
    --bg-deep: #0a0a0f;
    --bg-card: #16161f;
    --bg-hover: #1e1e2a;
    --border: #2a2a3a;
    --text-primary: #e8e6f0;
    --text-secondary: #9896a8;
    --text-muted: #5d5b6e;
    --accent-purple: #8b5cf6;
    --accent-violet: #6c3aff;
    --accent-cyan: #06b6d4;
    --accent-gold: #f59e0b;
    --accent-green: #10b981;
    --accent-red: #ef4444;
    --glow-purple: 0 0 30px #8b5cf640;
    --radius: 12px;
    --font-display: 'Outfit', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background: var(--bg-deep);
    color: var(--text-primary);
    font-family: var(--font-display);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow-x: hidden;
    user-select: none;
}

body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 30% 20%, #8b5cf608 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, #10b98108 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
}

.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    text-align: center;
    padding: 15px;
    z-index: 10;
}

.logo { height: 35px; filter: drop-shadow(0 0 10px rgba(139,92,246,0.3)); }

h1 {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 400;
    letter-spacing: 4px;
    color: var(--text-muted);
    margin-top: 8px;
    text-transform: uppercase;
}

.counter-container {
    position: relative;
    z-index: 5;
    text-align: center;
    padding-top: 60px;
}

.exercise-name {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--accent-purple);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.exercise-name:hover { color: var(--text-primary); }

/* Tempo Display */
.tempo-display {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin-bottom: 15px;
}

.tempo-digit {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: var(--font-mono);
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
}

.tempo-digit:hover {
    border-color: var(--accent-purple);
    background: var(--bg-hover);
}

.tempo-digit.active {
    border-color: var(--accent-green);
    background: rgba(16, 185, 129, 0.2);
    color: var(--accent-green);
}

.tempo-digit.down.active { border-color: var(--accent-cyan); background: rgba(6, 182, 212, 0.2); color: var(--accent-cyan); }
.tempo-digit.hold.active { border-color: var(--accent-gold); background: rgba(245, 158, 11, 0.2); color: var(--accent-gold); }
.tempo-digit.up.active { border-color: var(--accent-green); background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
.tempo-digit.top.active { border-color: var(--accent-purple); background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }

.tempo-sep {
    display: flex;
    align-items: center;
    color: var(--text-muted);
    font-family: var(--font-mono);
}

.tempo-labels {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin-bottom: 20px;
}

.tempo-label {
    width: 36px;
    font-family: var(--font-mono);
    font-size: 0.5rem;
    color: var(--text-muted);
    text-align: center;
    text-transform: uppercase;
}

/* Phase indicator */
.phase-indicator {
    font-family: var(--font-mono);
    font-size: 1.2rem;
    font-weight: 600;
    letter-spacing: 3px;
    margin-bottom: 10px;
    height: 30px;
    color: var(--text-muted);
    transition: all 0.2s ease;
}

.phase-indicator.down { color: var(--accent-cyan); }
.phase-indicator.hold { color: var(--accent-gold); }
.phase-indicator.up { color: var(--accent-green); }
.phase-indicator.top { color: var(--accent-purple); }

/* Counter */
.counter-display {
    position: relative;
    width: 220px;
    height: 220px;
    margin: 0 auto;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
}

.progress-ring {
    position: absolute;
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.progress-ring circle { fill: none; stroke-width: 4; }
.progress-ring .bg { stroke: var(--border); }
.progress-ring .progress {
    stroke: url(#gradient);
    stroke-linecap: round;
    transition: stroke-dashoffset 0.3s ease;
}

/* Phase progress ring */
.phase-ring {
    position: absolute;
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.phase-ring circle { fill: none; stroke-width: 8; }
.phase-ring .phase-progress {
    stroke: var(--accent-cyan);
    stroke-linecap: round;
    transition: stroke-dashoffset 0.1s linear;
}

.rep-number {
    font-family: var(--font-mono);
    font-size: 5rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
    transition: all 0.15s ease;
}

.rep-number.pulse {
    transform: scale(1.1);
    color: var(--accent-green);
}

.target-display {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 15px;
}

.target-display span { color: var(--accent-purple); }

.set-display {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 8px;
}

/* Controls */
.controls {
    display: flex;
    gap: 10px;
    margin-top: 25px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 1px;
    padding: 12px 20px;
    border: 1px solid var(--border);
    border-radius: 100px;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
}

.btn:hover {
    border-color: var(--accent-purple);
    color: var(--text-primary);
    background: var(--bg-hover);
}

.btn-primary {
    background: var(--accent-violet);
    border-color: var(--accent-violet);
    color: white;
    box-shadow: var(--glow-purple);
}

.btn-primary:hover { background: #7c4dff; }

.btn-auto {
    background: var(--accent-green);
    border-color: var(--accent-green);
    color: #000;
}

.btn-auto.running {
    background: var(--accent-red);
    border-color: var(--accent-red);
}

/* Settings */
.settings {
    position: fixed;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15px;
    padding: 12px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    z-index: 10;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 95%;
}

.setting { text-align: center; }

.setting-label {
    font-family: var(--font-mono);
    font-size: 0.55rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
}

.setting-value {
    display: flex;
    align-items: center;
    gap: 8px;
}

.setting-value button {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.setting-value button:hover {
    border-color: var(--accent-purple);
    color: var(--text-primary);
}

.setting-value span {
    font-family: var(--font-mono);
    font-size: 1rem;
    color: var(--text-primary);
    min-width: 25px;
    text-align: center;
}

/* Popups */
.overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 50;
    display: none;
}

.overlay.visible { display: block; }

.popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-card);
    border: 1px solid var(--accent-purple);
    border-radius: var(--radius);
    padding: 25px;
    z-index: 100;
    display: none;
    text-align: center;
    box-shadow: var(--glow-purple);
    max-width: 90%;
}

.popup.visible { display: block; animation: popIn 0.3s ease; }

@keyframes popIn {
    from { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
    to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}

.popup h2 {
    font-size: 1.2rem;
    margin-bottom: 15px;
    color: var(--accent-green);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.stat-item .value {
    font-family: var(--font-mono);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent-purple);
}

.stat-item .label {
    font-size: 0.6rem;
    color: var(--text-muted);
    text-transform: uppercase;
}

/* Exercise list */
.exercise-list {
    max-height: 60vh;
    overflow-y: auto;
    min-width: 260px;
}

.exercise-list h3 {
    font-size: 0.85rem;
    margin-bottom: 12px;
}

.exercise-option {
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.exercise-option:hover {
    border-color: var(--accent-purple);
    background: var(--bg-hover);
}

.exercise-tempo {
    font-size: 0.65rem;
    color: var(--text-muted);
}

footer {
    position: fixed;
    bottom: 75px;
    left: 0; right: 0;
    text-align: center;
    font-family: var(--font-mono);
    font-size: 0.55rem;
    color: var(--text-muted);
    letter-spacing: 2px;
}

@media (max-width: 480px) {
    .counter-display { width: 180px; height: 180px; }
    .rep-number { font-size: 4rem; }
    .tempo-digit { width: 32px; height: 32px; font-size: 1rem; }
    .settings { gap: 10px; padding: 10px 15px; }
}
</style>
</head>
<body>

<header class="header">
    <img src="https://raw.githubusercontent.com/gabosaturno11/titan-forge/main/assets/logo-planete-azul.png"
         alt="Saturno Movement" class="logo" onerror="this.style.display='none'">
    <h1>Rep Counter</h1>
</header>

<div class="counter-container">
    <div class="exercise-name" id="exerciseName" onclick="showExerciseList()">PUSH-UPS</div>

    <!-- Tempo Display: Eccentric - Bottom Hold - Concentric - Top Hold -->
    <div class="tempo-display">
        <div class="tempo-digit down" id="tempo0" onclick="adjustTempo(0, 1)">3</div>
        <div class="tempo-sep">-</div>
        <div class="tempo-digit hold" id="tempo1" onclick="adjustTempo(1, 1)">2</div>
        <div class="tempo-sep">-</div>
        <div class="tempo-digit up" id="tempo2" onclick="adjustTempo(2, 1)">3</div>
        <div class="tempo-sep">-</div>
        <div class="tempo-digit top" id="tempo3" onclick="adjustTempo(3, 1)">1</div>
    </div>
    <div class="tempo-labels">
        <div class="tempo-label">DOWN</div>
        <div class="tempo-label" style="width:10px"></div>
        <div class="tempo-label">HOLD</div>
        <div class="tempo-label" style="width:10px"></div>
        <div class="tempo-label">UP</div>
        <div class="tempo-label" style="width:10px"></div>
        <div class="tempo-label">TOP</div>
    </div>

    <!-- Phase Indicator -->
    <div class="phase-indicator" id="phaseIndicator">READY</div>

    <div class="counter-display" id="counterDisplay">
        <svg class="progress-ring" viewBox="0 0 220 220">
            <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#8b5cf6"/>
                    <stop offset="100%" stop-color="#10b981"/>
                </linearGradient>
            </defs>
            <circle class="bg" cx="110" cy="110" r="100"/>
            <circle class="progress" id="progressCircle" cx="110" cy="110" r="100"
                    stroke-dasharray="628.3" stroke-dashoffset="628.3"/>
        </svg>
        <svg class="phase-ring" viewBox="0 0 220 220">
            <circle class="phase-progress" id="phaseCircle" cx="110" cy="110" r="95"
                    stroke-dasharray="597" stroke-dashoffset="597"/>
        </svg>
        <div class="rep-number" id="repNumber">0</div>
    </div>

    <div class="target-display">TARGET: <span id="targetDisplay">10</span> REPS</div>
    <div class="set-display">SET <span id="currentSet">1</span> OF <span id="totalSets">3</span></div>

    <div class="controls">
        <button class="btn" onclick="decrementRep()">-1</button>
        <button class="btn btn-auto" id="autoBtn" onclick="toggleAuto()">AUTO</button>
        <button class="btn btn-primary" onclick="incrementRep()">+1</button>
        <button class="btn" onclick="nextSet()">NEXT</button>
    </div>
</div>

<div class="settings">
    <div class="setting">
        <div class="setting-label">Target</div>
        <div class="setting-value">
            <button onclick="adjustTarget(-1)">-</button>
            <span id="targetValue">10</span>
            <button onclick="adjustTarget(1)">+</button>
        </div>
    </div>
    <div class="setting">
        <div class="setting-label">Sets</div>
        <div class="setting-value">
            <button onclick="adjustSets(-1)">-</button>
            <span id="setsValue">3</span>
            <button onclick="adjustSets(1)">+</button>
        </div>
    </div>
    <div class="setting">
        <button class="btn" onclick="resetAll()">RESET</button>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePopups()"></div>

<div class="popup" id="statsPopup">
    <h2>SET COMPLETE</h2>
    <div class="stats-grid">
        <div class="stat-item"><div class="value" id="statReps">10</div><div class="label">Reps</div></div>
        <div class="stat-item"><div class="value" id="statSet">1/3</div><div class="label">Set</div></div>
        <div class="stat-item"><div class="value" id="statTotal">10</div><div class="label">Total</div></div>
        <div class="stat-item"><div class="value" id="statRemaining">2</div><div class="label">Left</div></div>
    </div>
    <button class="btn btn-primary" onclick="closePopups(); nextSet();">CONTINUE</button>
</div>

<div class="popup exercise-list" id="exerciseList">
    <h3>SELECT EXERCISE</h3>
    <div class="exercise-option" onclick="selectExercise('PUSH-UPS', [3,2,3,1])">
        Push-Ups <span class="exercise-tempo">3-2-3-1</span>
    </div>
    <div class="exercise-option" onclick="selectExercise('PULL-UPS', [3,1,2,1])">
        Pull-Ups <span class="exercise-tempo">3-1-2-1</span>
    </div>
    <div class="exercise-option" onclick="selectExercise('SQUATS', [4,2,2,1])">
        Squats <span class="exercise-tempo">4-2-2-1</span>
    </div>
    <div class="exercise-option" onclick="selectExercise('DIPS', [3,1,2,1])">
        Dips <span class="exercise-tempo">3-1-2-1</span>
    </div>
    <div class="exercise-option" onclick="selectExercise('LUNGES', [3,1,2,0])">
        Lunges <span class="exercise-tempo">3-1-2-0</span>
    </div>
    <div class="exercise-option" onclick="selectExercise('ROWS', [2,1,3,1])">
        Rows <span class="exercise-tempo">2-1-3-1</span>
    </div>
    <div class="exercise-option" onclick="selectExercise('PIKE PUSH-UPS', [3,1,2,1])">
        Pike Push-Ups <span class="exercise-tempo">3-1-2-1</span>
    </div>
    <div class="exercise-option" onclick="selectExercise('LEG RAISES', [2,1,3,1])">
        Leg Raises <span class="exercise-tempo">2-1-3-1</span>
    </div>
    <div class="exercise-option" onclick="selectExercise('PLANK HOLD', [0,30,0,0])">
        Plank Hold <span class="exercise-tempo">0-30-0-0</span>
    </div>
    <div class="exercise-option" onclick="selectExercise('EXPLOSIVE', [1,0,1,0])">
        Explosive <span class="exercise-tempo">1-0-1-0</span>
    </div>
</div>

<footer>SATURNO MOVEMENT</footer>

<script>
let audioCtx = null;

// State
let currentReps = 0;
let targetReps = 10;
let currentSet = 1;
let totalSets = 3;
let totalReps = 0;
let currentExercise = 'PUSH-UPS';
let tempo = [3, 2, 3, 1]; // down, hold, up, top

// Auto mode
let autoRunning = false;
let autoInterval = null;
let currentPhase = -1; // 0=down, 1=hold, 2=up, 3=top
let phaseTime = 0;

const phaseNames = ['DOWN', 'HOLD', 'UP', 'TOP'];
const phaseClasses = ['down', 'hold', 'up', 'top'];
const circumference = 2 * Math.PI * 100;
const phaseCircumference = 2 * Math.PI * 95;

function init() {
    loadProgress();
    updateDisplay();
    updateTempoDisplay();

    document.getElementById('counterDisplay').addEventListener('click', () => {
        if (!autoRunning) incrementRep();
    });

    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') { e.preventDefault(); toggleAuto(); }
        else if (e.code === 'ArrowUp') incrementRep();
        else if (e.code === 'ArrowDown') decrementRep();
        else if (e.code === 'ArrowRight') nextSet();
        else if (e.code === 'KeyR') resetAll();
    });
}

function toggleAuto() {
    if (autoRunning) {
        stopAuto();
    } else {
        startAuto();
    }
}

function startAuto() {
    autoRunning = true;
    document.getElementById('autoBtn').textContent = 'STOP';
    document.getElementById('autoBtn').classList.add('running');
    currentPhase = 0;
    phaseTime = 0;
    playPhaseSound(currentPhase);
    updatePhaseIndicator();

    autoInterval = setInterval(() => {
        const phaseDuration = tempo[currentPhase];

        if (phaseDuration === 0) {
            // Skip this phase
            nextPhase();
            return;
        }

        phaseTime++;

        // Update phase progress ring
        const progress = phaseTime / phaseDuration;
        const offset = phaseCircumference - (progress * phaseCircumference);
        document.getElementById('phaseCircle').style.strokeDashoffset = offset;
        document.getElementById('phaseCircle').style.stroke = getPhaseColor(currentPhase);

        if (phaseTime >= phaseDuration) {
            nextPhase();
        }
    }, 1000);
}

function nextPhase() {
    phaseTime = 0;
    currentPhase++;

    if (currentPhase > 3) {
        // Rep complete
        currentPhase = 0;
        incrementRep();

        if (currentReps >= targetReps) {
            stopAuto();
            showStats();
            return;
        }
    }

    // Skip phases with 0 duration
    while (tempo[currentPhase] === 0 && currentPhase <= 3) {
        currentPhase++;
        if (currentPhase > 3) {
            currentPhase = 0;
            incrementRep();
            if (currentReps >= targetReps) {
                stopAuto();
                showStats();
                return;
            }
        }
    }

    playPhaseSound(currentPhase);
    updatePhaseIndicator();
}

function stopAuto() {
    autoRunning = false;
    clearInterval(autoInterval);
    document.getElementById('autoBtn').textContent = 'AUTO';
    document.getElementById('autoBtn').classList.remove('running');
    document.getElementById('phaseIndicator').textContent = 'READY';
    document.getElementById('phaseIndicator').className = 'phase-indicator';
    document.getElementById('phaseCircle').style.strokeDashoffset = phaseCircumference;
    currentPhase = -1;
}

function updatePhaseIndicator() {
    const indicator = document.getElementById('phaseIndicator');
    indicator.textContent = phaseNames[currentPhase];
    indicator.className = 'phase-indicator ' + phaseClasses[currentPhase];

    // Highlight tempo digit
    document.querySelectorAll('.tempo-digit').forEach((el, i) => {
        el.classList.toggle('active', i === currentPhase);
    });
}

function getPhaseColor(phase) {
    const colors = ['#06b6d4', '#f59e0b', '#10b981', '#8b5cf6'];
    return colors[phase];
}

function adjustTempo(index, delta) {
    if (autoRunning) return;
    tempo[index] = Math.max(0, Math.min(30, tempo[index] + delta));
    updateTempoDisplay();
    saveProgress();
    playSound('click');

    // Long press for decrement
    if (delta > 0) {
        document.getElementById('tempo' + index).oncontextmenu = (e) => {
            e.preventDefault();
            adjustTempo(index, -1);
        };
    }
}

function updateTempoDisplay() {
    tempo.forEach((val, i) => {
        document.getElementById('tempo' + i).textContent = val;
    });
}

function incrementRep() {
    currentReps++;
    totalReps++;

    const repNum = document.getElementById('repNumber');
    repNum.classList.add('pulse');
    setTimeout(() => repNum.classList.remove('pulse'), 150);

    if (!autoRunning) playSound('tap');
    updateDisplay();
    saveProgress();

    if (currentReps === targetReps && !autoRunning) {
        showStats();
    }
}

function decrementRep() {
    if (currentReps > 0) {
        currentReps--;
        totalReps--;
        updateDisplay();
        saveProgress();
        playSound('click');
    }
}

function nextSet() {
    if (autoRunning) stopAuto();
    if (currentSet < totalSets) {
        currentSet++;
        currentReps = 0;
        updateDisplay();
        saveProgress();
        playSound('set');
    } else {
        playSound('finish');
        alert('Workout complete! Total: ' + totalReps + ' reps');
    }
}

function updateDisplay() {
    document.getElementById('repNumber').textContent = currentReps;
    document.getElementById('targetDisplay').textContent = targetReps;
    document.getElementById('targetValue').textContent = targetReps;
    document.getElementById('currentSet').textContent = currentSet;
    document.getElementById('totalSets').textContent = totalSets;
    document.getElementById('setsValue').textContent = totalSets;
    document.getElementById('exerciseName').textContent = currentExercise;

    const progress = Math.min(currentReps / targetReps, 1);
    const offset = circumference - (progress * circumference);
    document.getElementById('progressCircle').style.strokeDashoffset = offset;
}

function adjustTarget(delta) {
    targetReps = Math.max(1, Math.min(100, targetReps + delta));
    updateDisplay();
    saveProgress();
}

function adjustSets(delta) {
    totalSets = Math.max(1, Math.min(20, totalSets + delta));
    updateDisplay();
    saveProgress();
}

function resetAll() {
    if (autoRunning) stopAuto();
    currentReps = 0;
    currentSet = 1;
    totalReps = 0;
    updateDisplay();
    saveProgress();
    playSound('reset');
}

function showStats() {
    document.getElementById('statReps').textContent = currentReps;
    document.getElementById('statSet').textContent = currentSet + '/' + totalSets;
    document.getElementById('statTotal').textContent = totalReps;
    document.getElementById('statRemaining').textContent = Math.max(0, totalSets - currentSet);
    document.getElementById('overlay').classList.add('visible');
    document.getElementById('statsPopup').classList.add('visible');
}

function showExerciseList() {
    if (autoRunning) return;
    document.getElementById('overlay').classList.add('visible');
    document.getElementById('exerciseList').classList.add('visible');
}

function selectExercise(name, newTempo) {
    currentExercise = name;
    tempo = newTempo;
    updateDisplay();
    updateTempoDisplay();
    closePopups();
    saveProgress();
}

function closePopups() {
    document.getElementById('overlay').classList.remove('visible');
    document.getElementById('statsPopup').classList.remove('visible');
    document.getElementById('exerciseList').classList.remove('visible');
}

function saveProgress() {
    localStorage.setItem('repCounter', JSON.stringify({
        currentReps, targetReps, currentSet, totalSets, totalReps, currentExercise, tempo
    }));
}

function loadProgress() {
    const saved = localStorage.getItem('repCounter');
    if (saved) {
        const data = JSON.parse(saved);
        currentReps = data.currentReps || 0;
        targetReps = data.targetReps || 10;
        currentSet = data.currentSet || 1;
        totalSets = data.totalSets || 3;
        totalReps = data.totalReps || 0;
        currentExercise = data.currentExercise || 'PUSH-UPS';
        tempo = data.tempo || [3, 2, 3, 1];
    }
}

// AUDIO - Aggressive Sci-Fi
function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function makeDistortion(amount) {
    const dist = audioCtx.createWaveShaper();
    const k = amount;
    const samples = 44100;
    const curve = new Float32Array(samples);
    for (let i = 0; i < samples; i++) {
        const x = (i * 2) / samples - 1;
        curve[i] = ((3 + k) * x * 20 * (Math.PI / 180)) / (Math.PI + k * Math.abs(x));
    }
    dist.curve = curve;
    dist.oversample = '4x';
    return dist;
}

function playPhaseSound(phase) {
    initAudio();
    const now = audioCtx.currentTime;
    const freqs = [150, 200, 300, 250]; // Different freq per phase
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();

    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(freqs[phase], now);
    osc.frequency.exponentialRampToValueAtTime(freqs[phase] * 0.5, now + 0.15);

    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(2000, now);
    filter.frequency.exponentialRampToValueAtTime(200, now + 0.15);

    gain.gain.setValueAtTime(0.25, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);

    osc.connect(filter);
    filter.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start(now);
    osc.stop(now + 0.15);
}

function playSound(type) {
    initAudio();
    const now = audioCtx.currentTime;

    if (type === 'tap') {
        const osc = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const filter = audioCtx.createBiquadFilter();
        const dist = makeDistortion(50);

        osc.type = 'sawtooth';
        osc2.type = 'square';
        osc.frequency.setValueAtTime(200, now);
        osc.frequency.exponentialRampToValueAtTime(60, now + 0.15);
        osc2.frequency.setValueAtTime(150, now);
        osc2.frequency.exponentialRampToValueAtTime(40, now + 0.15);

        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(3000, now);
        filter.frequency.exponentialRampToValueAtTime(100, now + 0.15);
        filter.Q.value = 8;

        gain.gain.setValueAtTime(0.4, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);

        osc.connect(dist);
        osc2.connect(dist);
        dist.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);

        osc.start(now);
        osc2.start(now);
        osc.stop(now + 0.15);
        osc2.stop(now + 0.15);

    } else if (type === 'click') {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(400, now);
        gain.gain.setValueAtTime(0.15, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.05);

    } else if (type === 'set') {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const filter = audioCtx.createBiquadFilter();
        const dist = makeDistortion(30);

        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(80, now);
        osc.frequency.exponentialRampToValueAtTime(400, now + 0.2);
        osc.frequency.exponentialRampToValueAtTime(50, now + 0.4);

        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(200, now);
        filter.frequency.exponentialRampToValueAtTime(2000, now + 0.2);
        filter.frequency.exponentialRampToValueAtTime(100, now + 0.4);

        gain.gain.setValueAtTime(0.35, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);

        osc.connect(dist);
        dist.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.4);

    } else if (type === 'finish') {
        const sub = audioCtx.createOscillator();
        const subGain = audioCtx.createGain();
        sub.type = 'sine';
        sub.frequency.setValueAtTime(30, now);
        subGain.gain.setValueAtTime(0.5, now);
        subGain.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
        sub.connect(subGain);
        subGain.connect(audioCtx.destination);
        sub.start(now);
        sub.stop(now + 0.8);

        [1, 2, 3, 4].forEach((m, i) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(60 * m, now + i * 0.05);
            osc.frequency.exponentialRampToValueAtTime(30 * m, now + i * 0.05 + 0.3);
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(1000, now);
            filter.frequency.exponentialRampToValueAtTime(50, now + 0.5);
            gain.gain.setValueAtTime(0.2, now + i * 0.05);
            gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.05 + 0.5);
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now + i * 0.05);
            osc.stop(now + i * 0.05 + 0.5);
        });

    } else if (type === 'reset') {
        const osc = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const filter = audioCtx.createBiquadFilter();
        const dist = makeDistortion(40);

        osc.type = 'sawtooth';
        osc2.type = 'square';
        osc.frequency.setValueAtTime(200, now);
        osc.frequency.exponentialRampToValueAtTime(30, now + 0.4);
        osc2.frequency.setValueAtTime(150, now);
        osc2.frequency.exponentialRampToValueAtTime(20, now + 0.4);

        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(1000, now);
        filter.frequency.exponentialRampToValueAtTime(50, now + 0.4);

        gain.gain.setValueAtTime(0.3, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);

        osc.connect(dist);
        osc2.connect(dist);
        dist.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);

        osc.start(now);
        osc2.start(now);
        osc.stop(now + 0.4);
        osc2.stop(now + 0.4);
    }
}

init();
</script>
</body>
</html>
